---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { actions } from "astro:actions";

// const result = Astro.getActionResult(actions.signIn);

// if (result && !result.error && result.data.cookies.length > 0) {
//   Astro.response.headers.append("Location", "/dashboard");
//   Astro.response.status = 302;

//   for (const cookie of result.data.cookies) {
//     Astro.response.headers.append("Set-Cookie", cookie);
//   }

//   return new Response(null, Astro.response);
// }
---

<BaseLayout>
  <div class="wrapper | space-y-8">
    <h1 class="text-3xl font-bold">Sign in</h1>

    <div
      id="error-box"
      class="alert-destructive hidden border-red-200 bg-red-50"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        ><circle cx="12" cy="12" r="10"></circle><line
          x1="12"
          x2="12"
          y1="8"
          y2="12"></line><line x1="12" x2="12.01" y1="16" y2="16"></line></svg
      >
      <h2>Something went wrong!</h2>
      <section id="error-message"></section>
    </div>

    <form id="signin-form" class="space-y-4">
      <input
        class="input"
        type="email"
        name="email"
        placeholder="Email"
        value="test@email.com"
        required
      />
      <input
        class="input"
        type="password"
        name="password"
        placeholder="Password"
        value="password"
        required
      />
      <button class="btn" type="submit">Sign in</button>
    </form>

    <p>
      Donâ€™t have an account?
      <a href="/sign-up" class="ml-1 underline">Sign up here</a>.
    </p>
  </div>
</BaseLayout>

<script>
  import { authClient } from "@/lib/auth-client";

  const form = document.querySelector<HTMLFormElement>("#signin-form");
  const errorBox = document.querySelector("#error-box") as HTMLElement;
  const errorMessage = document.querySelector("#error-message") as HTMLElement;

  const displayError = (message: string): void => {
    errorMessage.textContent = message;
    errorBox.classList.remove("hidden");
  };

  const hideError = (): void => {
    errorMessage.textContent = "";
    errorBox.classList.add("hidden");
  };

  form?.addEventListener("submit", async (e: SubmitEvent) => {
    e.preventDefault();
    hideError();

    const formData = new FormData(form);
    const email = formData.get("email") as string;
    const password = formData.get("password") as string;

    try {
      const result = await authClient.signIn.email({
        email,
        password,
      });

      if (result && !result.error) {
        return (window.location.href = "/dashboard");
      } else {
        displayError(result.error.message!);
      }
    } catch (error) {
      console.error("Unexpected error during sign in:", error);
    }
  });
</script>
